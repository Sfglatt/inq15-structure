---
title: "04_network"
author: "Sglatt"
date: '`r Sys.Date()`'
output: html_document
---
 
This script fits a network with EBICglasso and looks at node centrality and network structure.
Exploratory graph analysis uses EBICglasso, so this is comparable.
Clusters are defined based on the result of exploratory graph analysis (script 02) for a data-driven approach.
Suicide risk and non-risk groups are compared on centrality and structure with the Network Comparison Test.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages
```{r packages}
if (!require("network")) {
  install.packages("network")
  require("network")
}
if (!require("psychTools")) {
  install.packages("psychTools")
  require("psychTools")
}
if (!require("jmv")) {
  install.packages("jmv")
  require("jmv")
}
if (!require("psych")) {
  install.packages("psych")
  require("psych")
}
if (!require("ggplot2")) {
  install.packages("ggplot2")
  require("ggplot2")
}
if (!require("dplyr")) {
  install.packages("dplyr")
  require("dplyr")
}
if (!require("NetworkComparisonTest")) {
  install.packages("NetworkComparisonTest")
  require("NetworkComparisonTest")
}
if (!require("bootnet")) {
  install.packages("bootnet")
  require("bootnet")
}
if (!require("networktools")) {
  install.packages("networktools")
  require("networktools")
}
if (!require("qgraph")) {
  install.packages("qgraph")
  require("qgraph")
}
```

# Data
```{r data}
Data1 <- read.csv("01_output/863_scored_data.csv")

INQ_ebicglasso_dat <- dplyr::select(
  Data1,
  INQ_1, INQ_2, INQ_3, INQ_4, INQ_5, INQ_6, # Dimension 1
  INQ_7_r, INQ_8_r, INQ_10_r, INQ_13_r, INQ_14_r, INQ_15_r, # Dimension 2
  INQ_9, INQ_11, INQ_12 # Dimension 3
)
```

# Fit network
```{r network}
INQ_Network_eg <- estimateNetwork(INQ_ebicglasso_dat,
  default = "EBICglasso"
)

plot(INQ_Network_eg,
  layout = "spring",
  labels = TRUE
)

# Define clusters (data-driven from EGA)
groupsint <- list(
  "Burden" = c(1:6),
  "Reciprocal" = c(7:12),
  "Loneliness" = c(13:15)
)

network_inq_comm <- plot(INQ_Network_eg,
  groups = groupsint, color = c("lightcoral", "slategray2", "darkseagreen"),
  layout = "spring", labels = TRUE
)

intbridge <- bridge(network_inq_comm,
  communities = c(
    "1", "1", "1", "1", "1", "1",
    "2", "2", "2", "2", "2", "2",
    "3", "3", "3"
  ),
  useCommunities = "all",
  directed = NULL,
  nodes = NULL
)
intbridge
plot(intbridge)
```

# Centrality analyses
```{r centrality}
# Correlation-Stability Coefficient (CS-Coefficient) is the mean percentage of the sample that can be dropped
# to preserve a correlation of r = 0.7 between the sample’s centrality indices and the case-dropped bootstraps' centrality indices.
# If we can drop a lot of cases from our original sample and still preserve a high correlation between centrality indices,
# Then these nodes are not being influenced by sample characteristics (i.e., they’re probably stable in our population).
# CS-coefficient should not be below 0.25 to be interpreted, and preferably above 0.5.

bridge_INQ_cs <- bootnet(INQ_Network_eg,
  communities = c(
    "1", "1", "1", "1", "1", "1",
    "2", "2", "2", "2", "2", "2",
    "3", "3", "3"
  ),
  useCommunities = "all",
  nBoots = 1000,
  type = "case",
  nCores = 4,
  statistics = c(
    "strength",
    "BridgeStrength",
    "expectedInfluence"
  )
)

bridge_INQ_cs
plot(bridge_INQ_cs, c("BridgeStrength", "strength", "expectedInfluence"))
corStability(bridge_INQ_cs)


# Node strength, closeness, betweeness centrality
centralityPlot(INQ_Network_eg,
  include = "all",
  orderBy = "ExpectedInfluence"
)

bootnet_case_dropping_INQ_eg <- bootnet(INQ_Network_eg,
  nBoots = 1000,
  type = "case",
  nCores = 4,
  statistics = c(
    "betweenness",
    "closeness",
    "expectedInfluence"
  )
)

bootnet_case_dropping_INQ_eg$bootTable
plot(bootnet_case_dropping_INQ_eg, "all")
corStability(bootnet_case_dropping_INQ_eg)
```

# Bootstrap the network edges
```{r boostrap edges}
INQ_eg_boot <- bootnet(INQ_Network_eg,
  nBoots = 1000,
  nCores = 4
)
# Plot
plot(INQ_eg_boot, labels = TRUE)

plot(INQ_eg_boot, labels = FALSE, order = "sample")

# For regularized networks (like this one), this is interpreted differently then usual.
# Because regularization estimates the network models, all edge-estimates are biased towards zero,
# which implies that all sampling distributions are biased towards zero.
# So sampling distributions are not Confidence Intervals (CIs) centered on the true (unbiased) parameter value.
# This means that if the quantiles of the bootstrapped sampling distribution overlap with zero,
# it could be that the corresponding CI does not overlap with zero.
# However, if the quantiles of the bootstrapped sampling distribution do not overlap with zero,
# we know that also the corresponding CI does not overlap with zero
# Plot the quantile intervals only for the times the parameter was not set to zero:
plot(INQ_eg_boot, plot = "interval", split0 = TRUE, order = "sample", labels = FALSE)
```

# Centrality difference tests
Differences in node strength by dimension/most central item
```{r centrality difference tests}
# First dimension
differenceTest(INQ_eg_boot, "INQ_1", "INQ_2", "strength")
differenceTest(INQ_eg_boot, "INQ_1", "INQ_3", "strength")
differenceTest(INQ_eg_boot, "INQ_1", "INQ_4", "strength")
differenceTest(INQ_eg_boot, "INQ_1", "INQ_5", "strength")
differenceTest(INQ_eg_boot, "INQ_1", "INQ_6", "strength")

# Second dimension
differenceTest(INQ_eg_boot, "INQ_14_r", "INQ_7_r", "strength")
differenceTest(INQ_eg_boot, "INQ_14_r", "INQ_8_r", "strength")
differenceTest(INQ_eg_boot, "INQ_14_r", "INQ_10_r", "strength")
differenceTest(INQ_eg_boot, "INQ_14_r", "INQ_13_r", "strength")
differenceTest(INQ_eg_boot, "INQ_14_r", "INQ_15_r", "strength")

# Third dimension
differenceTest(INQ_eg_boot, "INQ_11", "INQ_9", "strength")
differenceTest(INQ_eg_boot, "INQ_11", "INQ_12", "strength")

# plot node strength differences
plot(INQ_eg_boot, "strength", plot = "difference", onlyNonZero = FALSE, order = "sample")

# Plot edge differences
plot(INQ_eg_boot, "edge", plot = "difference", onlyNonZero = TRUE, order = "sample")
```

# Compare networks of the suicide risk and non-risk groups
```{r network feature invariance}
# Data
INQ_nct <- Data1 %>%
  dplyr::filter(!is.na(sui_risk_check)) %>%
  dplyr::select(
    INQ_1, INQ_2, INQ_3, INQ_4, INQ_5, INQ_6, # Dimension 1
    INQ_7_r, INQ_8_r, INQ_10_r, INQ_13_r, INQ_14_r, INQ_15_r, # Dimension 2
    INQ_9, INQ_11, INQ_12, # Dimension 3
    sui_risk_check
  )

# Network comparison test
NCT <- NCT(
  data1 = INQ_nct[INQ_nct$sui_risk_check == "0", 1:15],
  data2 = INQ_nct[INQ_nct$sui_risk_check == "1", 1:15],
  it = 1000,
  binary.data = FALSE,
  paired = FALSE,
  weighted = TRUE,
  abs = TRUE,
  test.edges = TRUE,
  edges = "all",
  progressbar = TRUE,
  make.positive.definite = FALSE,
  p.adjust.methods = "none",
  test.centrality = TRUE, centrality = c("strength", "bridgeStrength"),
  nodes = "all",
  communities = c(
    "1", "1", "1", "1", "1", "1",
    "2", "2", "2", "2", "2", "2",
    "3", "3", "3"
  ),
  useCommunities = "all",
  estimatorArgs = list(),
  verbose = TRUE
)

summary(NCT)
plot(NCT, what = "strength")
plot(NCT, what = "network")
```

